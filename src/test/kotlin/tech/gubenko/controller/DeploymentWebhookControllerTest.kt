package tech.gubenko.controller

import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.http.MediaType
import org.springframework.test.web.servlet.MockMvc
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders
import org.springframework.test.web.servlet.result.MockMvcResultMatchers
import tech.gubenko.config.WebhookProperties

@SpringBootTest
@AutoConfigureMockMvc
internal class DeploymentWebhookControllerTest {
    @Autowired
    var mockMvc: MockMvc? = null

    @Autowired
    var webhookProperties: WebhookProperties? = null

    val payload = "{\"ref\":\"refs/heads/main\",\"before\":\"7629284f0f284f38fb05c84762322f9e6192510b\",\"after\":\"f2e5b22a6cbdb69a160a921d8afea4ea8d1ecd53\",\"repository\":{\"id\":633088949,\"node_id\":\"R_kgDOJbwrtQ\",\"name\":\"react-terminal-style\",\"full_name\":\"xgubenko/react-terminal-style\",\"private\":false,\"owner\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/xgubenko/react-terminal-style\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/xgubenko/react-terminal-style\",\"forks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/forks\",\"keys_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/teams\",\"hooks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/hooks\",\"issue_events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/events\",\"assignees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/tags\",\"blobs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/languages\",\"stargazers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/stargazers\",\"contributors_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contributors\",\"subscribers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscribers\",\"subscription_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscription\",\"commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/merges\",\"archive_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/downloads\",\"issues_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/deployments\",\"created_at\":1682535325,\"updated_at\":\"2023-05-04T19:35:15Z\",\"pushed_at\":1684257451,\"git_url\":\"git://github.com/xgubenko/react-terminal-style.git\",\"ssh_url\":\"git@github.com:xgubenko/react-terminal-style.git\",\"clone_url\":\"https://github.com/xgubenko/react-terminal-style.git\",\"svn_url\":\"https://github.com/xgubenko/react-terminal-style\",\"homepage\":null,\"size\":8196,\"stargazers_count\":1,\"watchers_count\":1,\"language\":\"JavaScript\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":true,\"has_discussions\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":{\"key\":\"mit\",\"name\":\"MIT License\",\"spdx_id\":\"MIT\",\"url\":\"https://api.github.com/licenses/mit\",\"node_id\":\"MDc6TGljZW5zZTEz\"},\"allow_forking\":true,\"is_template\":false,\"web_commit_signoff_required\":false,\"topics\":[],\"visibility\":\"public\",\"forks\":0,\"open_issues\":0,\"watchers\":1,\"default_branch\":\"main\",\"stargazers\":1,\"master_branch\":\"main\"},\"pusher\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\"},\"sender\":{\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/xgubenko/react-terminal-style/compare/7629284f0f28...f2e5b22a6cbd\",\"commits\":[{\"id\":\"1447a254b47216c9c7917615286f46ff266037d4\",\"tree_id\":\"955638914c18e65ca700866cf49f740b5f05250e\",\"distinct\":false,\"message\":\"small fixes\",\"timestamp\":\"2023-05-16T20:17:07+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/1447a254b47216c9c7917615286f46ff266037d4\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]},{\"id\":\"f2e5b22a6cbdb69a160a921d8afea4ea8d1ecd53\",\"tree_id\":\"02f4b979d42d99249cbe90c29e85402183b47137\",\"distinct\":true,\"message\":\"Merge pull request #20 from xgubenko/develop\\n\\nsmall fixes\",\"timestamp\":\"2023-05-16T20:17:30+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/f2e5b22a6cbdb69a160a921d8afea4ea8d1ecd53\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"username\":\"xgubenko\"},\"committer\":{\"name\":\"GitHub\",\"email\":\"noreply@github.com\",\"username\":\"web-flow\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}],\"head_commit\":{\"id\":\"f2e5b22a6cbdb69a160a921d8afea4ea8d1ecd53\",\"tree_id\":\"02f4b979d42d99249cbe90c29e85402183b47137\",\"distinct\":true,\"message\":\"Merge pull request #20 from xgubenko/develop\\n\\nsmall fixes\",\"timestamp\":\"2023-05-16T20:17:30+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/f2e5b22a6cbdb69a160a921d8afea4ea8d1ecd53\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"username\":\"xgubenko\"},\"committer\":{\"name\":\"GitHub\",\"email\":\"noreply@github.com\",\"username\":\"web-flow\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}}"

    @Test
    fun registerDroneSuccess() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post("/deploy")
                .content(payload)
                .header(webhookProperties!!.eventHeader, "push")
                .header(webhookProperties!!.signatureHeader, "wrong_signature")
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isUnauthorized)
            .andExpect(MockMvcResultMatchers.jsonPath("$.response").value("Signature verification failed"))
    }
}