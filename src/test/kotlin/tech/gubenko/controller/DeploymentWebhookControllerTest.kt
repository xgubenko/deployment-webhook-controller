package tech.gubenko.controller

import org.junit.jupiter.api.Test
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.http.MediaType
import org.springframework.test.web.servlet.MockMvc
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders
import org.springframework.test.web.servlet.result.MockMvcResultMatchers
import tech.gubenko.config.WebhookProperties

@SpringBootTest
@AutoConfigureMockMvc
internal class DeploymentWebhookControllerTest {
    @Autowired
    var mockMvc: MockMvc? = null

    @Autowired
    var webhookProperties: WebhookProperties? = null

    val DEPLOY_URI = "/deploy"
    val PAYLOAD =
        "{\"ref\":\"refs/heads/develop\",\"before\":\"1447a254b47216c9c7917615286f46ff266037d4\",\"after\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"repository\":{\"id\":633088949,\"node_id\":\"R_kgDOJbwrtQ\",\"name\":\"react-terminal-style\",\"full_name\":\"xgubenko/react-terminal-style\",\"private\":false,\"owner\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/xgubenko/react-terminal-style\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/xgubenko/react-terminal-style\",\"forks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/forks\",\"keys_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/teams\",\"hooks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/hooks\",\"issue_events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/events\",\"assignees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/tags\",\"blobs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/languages\",\"stargazers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/stargazers\",\"contributors_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contributors\",\"subscribers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscribers\",\"subscription_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscription\",\"commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/merges\",\"archive_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/downloads\",\"issues_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/deployments\",\"created_at\":1682535325,\"updated_at\":\"2023-05-04T19:35:15Z\",\"pushed_at\":1684430882,\"git_url\":\"git://github.com/xgubenko/react-terminal-style.git\",\"ssh_url\":\"git@github.com:xgubenko/react-terminal-style.git\",\"clone_url\":\"https://github.com/xgubenko/react-terminal-style.git\",\"svn_url\":\"https://github.com/xgubenko/react-terminal-style\",\"homepage\":null,\"size\":8198,\"stargazers_count\":1,\"watchers_count\":1,\"language\":\"JavaScript\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":true,\"has_discussions\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":{\"key\":\"mit\",\"name\":\"MIT License\",\"spdx_id\":\"MIT\",\"url\":\"https://api.github.com/licenses/mit\",\"node_id\":\"MDc6TGljZW5zZTEz\"},\"allow_forking\":true,\"is_template\":false,\"web_commit_signoff_required\":false,\"topics\":[],\"visibility\":\"public\",\"forks\":0,\"open_issues\":0,\"watchers\":1,\"default_branch\":\"main\",\"stargazers\":1,\"master_branch\":\"main\"},\"pusher\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\"},\"sender\":{\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/xgubenko/react-terminal-style/compare/1447a254b472...aebc6552ce37\",\"commits\":[{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}],\"head_commit\":{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}}"
    val SIGNATURE_PAYLOAD = "sha1=6f6197176a06be6c93bd740ea2e165713ed8479b"

    val PAYLOAD_PUSHER_NOT_EXIST =
        "{\"ref\":\"refs/heads/develop\",\"before\":\"1447a254b47216c9c7917615286f46ff266037d4\",\"after\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"repository\":{\"id\":633088949,\"node_id\":\"R_kgDOJbwrtQ\",\"name\":\"react-terminal-style\",\"full_name\":\"xgubenko/react-terminal-style\",\"private\":false,\"owner\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/xgubenko/react-terminal-style\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/xgubenko/react-terminal-style\",\"forks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/forks\",\"keys_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/teams\",\"hooks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/hooks\",\"issue_events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/events\",\"assignees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/tags\",\"blobs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/languages\",\"stargazers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/stargazers\",\"contributors_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contributors\",\"subscribers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscribers\",\"subscription_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscription\",\"commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/merges\",\"archive_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/downloads\",\"issues_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/deployments\",\"created_at\":1682535325,\"updated_at\":\"2023-05-04T19:35:15Z\",\"pushed_at\":1684430882,\"git_url\":\"git://github.com/xgubenko/react-terminal-style.git\",\"ssh_url\":\"git@github.com:xgubenko/react-terminal-style.git\",\"clone_url\":\"https://github.com/xgubenko/react-terminal-style.git\",\"svn_url\":\"https://github.com/xgubenko/react-terminal-style\",\"homepage\":null,\"size\":8198,\"stargazers_count\":1,\"watchers_count\":1,\"language\":\"JavaScript\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":true,\"has_discussions\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":{\"key\":\"mit\",\"name\":\"MIT License\",\"spdx_id\":\"MIT\",\"url\":\"https://api.github.com/licenses/mit\",\"node_id\":\"MDc6TGljZW5zZTEz\"},\"allow_forking\":true,\"is_template\":false,\"web_commit_signoff_required\":false,\"topics\":[],\"visibility\":\"public\",\"forks\":0,\"open_issues\":0,\"watchers\":1,\"default_branch\":\"main\",\"stargazers\":1,\"master_branch\":\"main\"},\"pusher\":{\"name\":\"xgubenko123\",\"email\":\"46753008+xgubenko@users.noreply.github.com\"},\"sender\":{\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/xgubenko/react-terminal-style/compare/1447a254b472...aebc6552ce37\",\"commits\":[{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}],\"head_commit\":{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}}"
    val SIGNATURE_PUSHER_NOT_EXIST = "sha1=1e03fa66885f1a94beaf02475d54bb52c8aa4a8c"

    val PAYLOAD_ORIGIN_FAILURE =
        "{\"ref\":\"refs/heads/develop\",\"before\":\"1447a254b47216c9c7917615286f46ff266037d4\",\"after\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"repository\":{\"id\":633088949,\"node_id\":\"R_kgDOJbwrtQ\",\"name\":\"react-terminal-style\",\"full_name\":\"xgubenko/react-terminal-style\",\"private\":false,\"owner\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\",\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"html_url\":\"https://github.com/xgubenko/react-terminal-style123\",\"description\":null,\"fork\":false,\"url\":\"https://github.com/xgubenko/react-terminal-style\",\"forks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/forks\",\"keys_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/keys{/key_id}\",\"collaborators_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/collaborators{/collaborator}\",\"teams_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/teams\",\"hooks_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/hooks\",\"issue_events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/events{/number}\",\"events_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/events\",\"assignees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/assignees{/user}\",\"branches_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/branches{/branch}\",\"tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/tags\",\"blobs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/blobs{/sha}\",\"git_tags_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/tags{/sha}\",\"git_refs_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/refs{/sha}\",\"trees_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/trees{/sha}\",\"statuses_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/statuses/{sha}\",\"languages_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/languages\",\"stargazers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/stargazers\",\"contributors_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contributors\",\"subscribers_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscribers\",\"subscription_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/subscription\",\"commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/commits{/sha}\",\"git_commits_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/git/commits{/sha}\",\"comments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/comments{/number}\",\"issue_comment_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues/comments{/number}\",\"contents_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/contents/{+path}\",\"compare_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/compare/{base}...{head}\",\"merges_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/merges\",\"archive_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/{archive_format}{/ref}\",\"downloads_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/downloads\",\"issues_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/issues{/number}\",\"pulls_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/pulls{/number}\",\"milestones_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/milestones{/number}\",\"notifications_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/notifications{?since,all,participating}\",\"labels_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/labels{/name}\",\"releases_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/releases{/id}\",\"deployments_url\":\"https://api.github.com/repos/xgubenko/react-terminal-style/deployments\",\"created_at\":1682535325,\"updated_at\":\"2023-05-04T19:35:15Z\",\"pushed_at\":1684430882,\"git_url\":\"git://github.com/xgubenko/react-terminal-style.git\",\"ssh_url\":\"git@github.com:xgubenko/react-terminal-style.git\",\"clone_url\":\"https://github.com/xgubenko/react-terminal-style.git\",\"svn_url\":\"https://github.com/xgubenko/react-terminal-style\",\"homepage\":null,\"size\":8198,\"stargazers_count\":1,\"watchers_count\":1,\"language\":\"JavaScript\",\"has_issues\":true,\"has_projects\":true,\"has_downloads\":true,\"has_wiki\":true,\"has_pages\":true,\"has_discussions\":false,\"forks_count\":0,\"mirror_url\":null,\"archived\":false,\"disabled\":false,\"open_issues_count\":0,\"license\":{\"key\":\"mit\",\"name\":\"MIT License\",\"spdx_id\":\"MIT\",\"url\":\"https://api.github.com/licenses/mit\",\"node_id\":\"MDc6TGljZW5zZTEz\"},\"allow_forking\":true,\"is_template\":false,\"web_commit_signoff_required\":false,\"topics\":[],\"visibility\":\"public\",\"forks\":0,\"open_issues\":0,\"watchers\":1,\"default_branch\":\"main\",\"stargazers\":1,\"master_branch\":\"main\"},\"pusher\":{\"name\":\"xgubenko\",\"email\":\"46753008+xgubenko@users.noreply.github.com\"},\"sender\":{\"login\":\"xgubenko\",\"id\":46753008,\"node_id\":\"MDQ6VXNlcjQ2NzUzMDA4\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/46753008?v=4\",\"gravatar_id\":\"\",\"url\":\"https://api.github.com/users/xgubenko\",\"html_url\":\"https://github.com/xgubenko\",\"followers_url\":\"https://api.github.com/users/xgubenko/followers\",\"following_url\":\"https://api.github.com/users/xgubenko/following{/other_user}\",\"gists_url\":\"https://api.github.com/users/xgubenko/gists{/gist_id}\",\"starred_url\":\"https://api.github.com/users/xgubenko/starred{/owner}{/repo}\",\"subscriptions_url\":\"https://api.github.com/users/xgubenko/subscriptions\",\"organizations_url\":\"https://api.github.com/users/xgubenko/orgs\",\"repos_url\":\"https://api.github.com/users/xgubenko/repos\",\"events_url\":\"https://api.github.com/users/xgubenko/events{/privacy}\",\"received_events_url\":\"https://api.github.com/users/xgubenko/received_events\",\"type\":\"User\",\"site_admin\":false},\"created\":false,\"deleted\":false,\"forced\":false,\"base_ref\":null,\"compare\":\"https://github.com/xgubenko/react-terminal-style/compare/1447a254b472...aebc6552ce37\",\"commits\":[{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}],\"head_commit\":{\"id\":\"aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"tree_id\":\"a9f0525c3d0390a5dcf2c343f5c5322c39c26b74\",\"distinct\":true,\"message\":\"changes for test\",\"timestamp\":\"2023-05-18T20:27:58+03:00\",\"url\":\"https://github.com/xgubenko/react-terminal-style/commit/aebc6552ce37fcd9da857bd00b9f322a9a8fee3c\",\"author\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"committer\":{\"name\":\"Aleksandr Gubenko\",\"email\":\"asd@Aleksandrs-MacBook-Pro.local\"},\"added\":[],\"removed\":[],\"modified\":[\"src/pages/Menu.jsx\"]}}"
    val SIGNATURE_ORIGIN_FAILURE = "sha1=7f49008028d6d41b84777ad84be01b1fb8de847e"

    @Test
    fun deployTreggerSuccess() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post(DEPLOY_URI)
                .content(PAYLOAD)
                .header(webhookProperties!!.eventHeader, "push")
                .header(webhookProperties!!.signatureHeader, SIGNATURE_PAYLOAD)
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isOk)
            .andExpect(MockMvcResultMatchers.jsonPath("$.response").value("Deploy triggered"))
    }

    @Test
    fun deployTriggersignatureVerificationFail() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post(DEPLOY_URI)
                .content(PAYLOAD)
                .header(webhookProperties!!.eventHeader, "push")
                .header(webhookProperties!!.signatureHeader, SIGNATURE_PUSHER_NOT_EXIST)
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isUnauthorized)
            .andExpect(MockMvcResultMatchers.jsonPath("$.response").value("Signature verification failed"))
    }

    @Test
    fun deployTriggerUserVerificationFail() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post(DEPLOY_URI)
                .content(PAYLOAD_PUSHER_NOT_EXIST)
                .header(webhookProperties!!.eventHeader, "push")
                .header(webhookProperties!!.signatureHeader, SIGNATURE_PUSHER_NOT_EXIST)
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isUnauthorized)
            .andExpect(MockMvcResultMatchers.jsonPath("$.response").value("User unauthorized"))
    }

    @Test
    fun deployTriggerPingSuccessful() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post(DEPLOY_URI)
                .content(PAYLOAD)
                .header(webhookProperties!!.eventHeader, "ping")
                .header(webhookProperties!!.signatureHeader, SIGNATURE_PAYLOAD)
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isOk)
            .andExpect(MockMvcResultMatchers.jsonPath("$.response").value("Ping successful"))
    }

    @Test
    fun deployTriggerRepositoryOriginFailure() {
        mockMvc!!.perform(
            MockMvcRequestBuilders.post(DEPLOY_URI)
                .content(PAYLOAD_ORIGIN_FAILURE)
                .header(webhookProperties!!.eventHeader, "push")
                .header(webhookProperties!!.signatureHeader, SIGNATURE_ORIGIN_FAILURE)
                .contentType(MediaType.APPLICATION_JSON)
        )
            .andExpect(MockMvcResultMatchers.status().isBadRequest)
            .andExpect(
                MockMvcResultMatchers.jsonPath("$.response").value("Repository with this origin will not be deployed")
            )
    }
}